{
    "rules": {
        "events": {
            ".read": true,
            ".write": false
        },
        "matches": {
            ".read": "auth != null",
            ".write": false,
            ".indexOn": [
                "createdAt",
                "isActive",
                "location",
                "fieldId",
                "organizerId",
                "isPublic",
                "dateTime"
            ],
            "$matchId": {
                ".read": "auth != null && (data.child('isPublic').val() == true || data.child('organizerId').val() == auth.uid || data.child('players').hasChild(auth.uid) || (data.child('invites').hasChild(auth.uid) && (data.child('invites').child(auth.uid).val() == 'pending' || data.child('invites').child(auth.uid).child('status').val() == 'pending')))",
                ".write": "auth != null && (data.child('organizerId').val() == auth.uid || (!data.exists() && newData.child('organizerId').val() == auth.uid))",
                "organizerId": {
                    ".validate": "newData.val() == auth.uid || (!data.exists() && newData.val() == auth.uid)"
                },
                "players": {
                    ".read": "auth != null",
                    ".write": "auth != null",
                    ".validate": "newData.hasChildren()"
                },
                "currentPlayers": {
                    ".read": "auth != null",
                    ".write": "auth != null && (root.child('matches/'+$matchId+'/organizerId').val() == auth.uid || newData.val() == data.val() + 1 || newData.val() == data.val() - 1)",
                    ".validate": "newData.isNumber() && newData.val() >= 0"
                },
                "invites": {
                    ".indexOn": [
                        "status"
                    ],
                    "$uid": {
                        ".read": "auth != null && ($uid === auth.uid || root.child('matches/'+$matchId+'/organizerId').val() === auth.uid)",
                        ".write": "auth != null && ($uid === auth.uid || root.child('matches/'+$matchId+'/organizerId').val() === auth.uid)",
                        "status": {
                            ".validate": "newData.isString() && (newData.val() == 'pending' || newData.val() == 'accepted' || newData.val() == 'declined' || newData.val() == 'left')"
                        }
                    }
                }
            }
        },
        "pendingInviteIndex": {
            "$uid": {
                ".read": "auth != null && auth.uid == $uid",
                "$matchId": {
                    ".write": "auth != null && ((auth.uid == $uid && (!data.exists() || newData.val() == null || newData.val() == 'pending')) || root.child('matches/'+$matchId+'/organizerId').val() === auth.uid)",
                    ".validate": "newData.val() == 'pending' || newData.val() == null"
                }
            }
        },
        "emailInvites": {
            ".read": "auth != null",
            ".indexOn": [
                "fromUid",
                "toEmail",
                "createdAt"
            ],
            "$inviteId": {
                ".write": "auth != null && ((newData.val() == null && data.child('fromUid').val() === auth.uid) || (newData.val() != null && newData.child('fromUid').val() === auth.uid && (!data.exists() || data.child('fromUid').val() === auth.uid)))",
                ".validate": "newData.hasChildren(['fromUid','toEmail','createdAt']) && newData.child('fromUid').isString() && newData.child('fromUid').val() === auth.uid && newData.child('toEmail').isString() && (newData.child('createdAt').isNumber() || (newData.child('createdAt').hasChildren(['.sv']) && newData.child('createdAt').child('.sv').val() === 'timestamp'))"
            }
        },
        "slots": {
            "$date": {
                "$field": {
                    ".read": "auth != null",
                    "$hhmm": {
                        ".read": "auth != null",
                        ".write": "auth != null",
                        ".validate": "newData.val() === true || newData.val() == null"
                    }
                }
            }
        },
        "users": {
            "$uid": {
                ".read": "auth != null && auth.uid == $uid",
                ".write": "auth != null && auth.uid == $uid",
                "profile": {
                    ".read": "auth != null"
                },
                "friendRequests": {
                    ".read": "auth != null && auth.uid == $uid",
                    "received": {
                        ".read": "auth != null && auth.uid == $uid",
                        "$fromUid": {
                            ".write": "auth != null && ((auth.uid == $fromUid && newData.val() === true) || (auth.uid == $uid && newData.val() == null) || (auth.uid == $fromUid && newData.val() == null))"
                        }
                    },
                    "sent": {
                        ".read": "auth != null && auth.uid == $uid",
                        "$toUid": {
                            ".write": "auth != null && ((auth.uid == $uid && (newData.val() === true || newData.val() == null)) || (auth.uid == $toUid && newData.val() == null))"
                        }
                    }
                },
                "friends": {
                    "$friendUid": {
                        ".write": "auth != null && (auth.uid == $uid || auth.uid == $friendUid)"
                    }
                },
                "matchInvites": {
                    "$matchId": {
                        ".read": "auth != null && auth.uid == $uid",
                        ".write": "auth != null && (auth.uid == $uid || root.child('matches/'+$matchId+'/organizerId').val() === auth.uid)"
                    }
                },
                "createdMatches": {
                    "$matchId": {
                        ".read": "auth != null && auth.uid == $uid",
                        ".write": "auth != null && auth.uid == $uid"
                    }
                },
                "joinedMatches": {
                    "$matchId": {
                        ".read": "auth != null && auth.uid == $uid",
                        ".write": "auth != null && auth.uid == $uid"
                    }
                },
                "settings": {
                    "profile": {
                        ".read": "auth != null"
                    }
                }
            }
        },
        "publicProfiles": {
            "$uid": {
                ".read": "auth != null",
                ".write": "auth != null && auth.uid == $uid",
                ".validate": "newData.hasChildren(['displayName']) && newData.child('displayName').isString()"
            }
        },
        "usersByEmailHash": {
            "$hash": {
                ".read": "auth != null",
                ".write": "auth != null && (!data.exists() || data.val() === auth.uid) && newData.val() === auth.uid"
            }
        },
        "usersByDisplayNameLower": {
            "$name": {
                "$uid": {
                    ".read": "auth != null",
                    ".write": "auth != null && $uid === auth.uid"
                }
            }
        },
        "friendTokens": {
            "$token": {
                ".read": "auth != null",
                ".write": "auth != null && ( (!data.exists() && newData.child('ownerUid').val() === auth.uid) || (data.exists() && data.child('ownerUid').val() === auth.uid) )",
                ".validate": "newData.hasChildren(['ownerUid','exp']) && newData.child('ownerUid').isString() && newData.child('exp').isNumber()"
            }
        },
        "reports": {
            "$id": {
                ".read": "false",
                ".write": "auth != null",
                ".validate": "newData.hasChildren(['reporter','target','reason','ts']) && newData.child('reporter').val() === auth.uid"
            }
        },
        "notification_requests": {
            "$requestId": {
                ".write": "auth != null"
            }
        },
        "mail": {
            "notifications": {
                "$id": {
                    ".read": "false",
                    ".write": "auth != null && ((newData.child('type').val() === 'friend_request' && newData.child('toUid').isString() && newData.child('fromUid').val() === auth.uid) || (newData.child('type').val() === 'friend_accept' && newData.child('toUid').isString() && newData.child('fromUid').val() === auth.uid) || (newData.child('type').val() === 'match_invite' && newData.child('toUid').isString() && newData.child('matchId').isString() && newData.child('fromUid').val() === auth.uid) || (newData.child('type').val() === 'match_edited' && newData.child('matchId').isString() && root.child('matches').child(newData.child('matchId').val()).child('organizerId').val() === auth.uid) || (newData.child('type').val() === 'match_cancelled' && newData.child('matchId').isString() && root.child('matches').child(newData.child('matchId').val()).child('organizerId').val() === auth.uid))",
                    ".validate": "newData.hasChild('type') && newData.child('type').isString()"
                }
            },
            "$emailId": {
                ".read": "false",
                ".write": "auth != null && $emailId != 'notifications'",
                ".validate": "newData.hasChild('to') && newData.child('to').isString() && newData.child('message').hasChildren(['subject','html','text'])"
            }
        }
    }
}